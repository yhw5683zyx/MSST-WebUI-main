# 移动云存储方案对比

## 方案对比

### 方案 A: 原方案 (US3 + SDK下载)
```
┌─────────────┐
│  音立方服务  │
└──────┬──────┘
       │ 1. 调用API (ecloud_key)
       ▼
┌─────────────────────────────────┐
│   MSST API 服务                 │
│   - 从移动云下载文件            │
│   - 执行音频分离                │
│   - 上传结果到移动云            │
│   - 回调通知音立方              │
└──────┬──────────────────────────┘
       │ 2. 回调 (ecloud_keys)
       ▼
┌─────────────┐
│  音立方服务  │
└──────┬──────┘
       │ 3. 使用SDK下载
       ▼
┌─────────────┐
│  移动云SDK  │
└──────┬──────┘
       │ 4. 下载文件
       ▼
┌─────────────┐
│  本地文件   │
└─────────────┘
```

**网络传输**: 4次 (下载→分离→上传→下载)  
**音立方依赖**: 需要移动云SDK  
**复杂度**: 中等

---

### 方案 B: 优化方案 (移动云 + 预签名URL) ⭐推荐
```
┌─────────────┐
│  音立方服务  │
└──────┬──────┘
       │ 1. 调用API (ecloud_key)
       ▼
┌─────────────────────────────────┐
│   MSST API 服务                 │
│   - 从移动云下载文件            │
│   - 执行音频分离                │
│   - 上传结果到移动云            │
│   - 生成预签名URL               │
│   - 回调通知音立方              │
└──────┬──────────────────────────┘
       │ 2. 回调 (download_urls)
       ▼
┌─────────────┐
│  音立方服务  │
└──────┬──────┘
       │ 3. 直接HTTP下载
       ▼
┌─────────────┐
│  本地文件   │
└─────────────┘
```

**网络传输**: 4次 (下载→分离→上传→下载)  
**音立方依赖**: 无需SDK,仅需HTTP客户端  
**复杂度**: 简单

---

## 详细对比

| 对比项 | 方案A (US3+SDK) | 方案B (预签名URL) ⭐ |
|--------|----------------|---------------------|
| **网络传输次数** | 4次 | 4次 |
| **音立方依赖** | 需要移动云SDK | 无需SDK |
| **实现复杂度** | 中等 | 简单 |
| **代码量** | 较多 | 较少 |
| **维护成本** | 需要维护SDK版本 | 无需维护 |
| **安全性** | 高 (SDK认证) | 高 (预签名URL) |
| **灵活性** | 中 | 高 |
| **下载方式** | SDK下载 | HTTP下载 |
| **URL有效期** | 无限制 | 可设置(建议1小时) |

---

## 方案B 优势

### 1. **音立方无需SDK**
```java
// 方案A: 需要SDK
EcloudClient client = new EcloudClient(accessKey, secretKey);
client.downloadFile(bucket, key, localPath);

// 方案B: 无需SDK,直接HTTP下载
String url = callbackData.getDownload_urls().get(0);
downloadByPresignedUrl(url, localPath);
```

### 2. **代码更简洁**
```java
// 方案B回调处理
public void handleCallback(CallbackData data) {
    for (String url : data.getDownload_urls()) {
        // 直接通过URL下载
        downloadByPresignedUrl(url, savePath);
    }
}
```

### 3. **降低维护成本**
- 无需关注SDK版本更新
- 无需处理SDK依赖冲突
- 代码更轻量

### 4. **更好的安全性**
- 预签名URL有时效性(默认1小时)
- URL过期后自动失效
- 可自定义有效期

---

## API 接口对比

### MSST API 回调响应

#### 方案A响应
```json
{
  "task_id": "uuid-123",
  "status": "completed",
  "ecloud_keys": [
    "separated/uuid-123/input_vocals.wav",
    "separated/uuid-123/input_instrumental.wav"
  ],
  "message": "Success"
}
```

#### 方案B响应 ⭐
```json
{
  "task_id": "uuid-123",
  "status": "completed",
  "ecloud_keys": [
    "separated/uuid-123/input_vocals.wav",
    "separated/uuid-123/input_instrumental.wav"
  ],
  "download_urls": [
    "https://eos-wuxi-1.cmecloud.cn/...?AWSAccessKeyId=...&Expires=...&Signature=...",
    "https://eos-wuxi-1.cmecloud.cn/...?AWSAccessKeyId=...&Expires=...&Signature=..."
  ],
  "url_expire_seconds": 3600,
  "message": "Success"
}
```

---

## 实现细节

### MSST 端 (Python)

```python
# 生成预签名URL
def generate_presigned_url(bucket_name: str, key: str, expire_seconds: int = 3600):
    url = s3_client.generate_presigned_url(
        ClientMethod='get_object',
        Params={'Bucket': bucket_name, 'Key': key},
        ExpiresIn=expire_seconds,
        HttpMethod='GET'
    )
    return url

# 回调响应
payload = {
    "task_id": task_id,
    "status": status,
    "ecloud_keys": result_keys,
    "download_urls": result_urls,  # 预签名URL列表
    "url_expire_seconds": PRESIGNED_URL_EXPIRE_SECONDS,
    "message": message
}
```

### 音立方端 (Java)

```java
// 回调处理
public void handleCallback(CallbackData data) {
    for (int i = 0; i < data.getDownload_urls().size(); i++) {
        String url = data.getDownload_urls().get(i);
        String filename = data.getEcloud_keys().get(i)
            .substring(data.getEcloud_keys().get(i).lastIndexOf("/") + 1);
        String savePath = "/path/to/save/" + filename;
        
        // 直接通过URL下载
        downloadByPresignedUrl(url, savePath);
    }
}

// HTTP下载实现
public void downloadByPresignedUrl(String presignedUrl, String savePath) {
    try (CloseableHttpClient httpClient = HttpClients.createDefault()) {
        HttpGet httpGet = new HttpGet(presignedUrl);
        HttpResponse response = httpClient.execute(httpGet);
        
        if (response.getStatusLine().getStatusCode() == 200) {
            byte[] fileData = EntityUtils.toByteArray(response.getEntity());
            java.nio.file.Files.write(
                java.nio.file.Paths.get(savePath), 
                fileData
            );
        }
    }
}
```

---

## 预签名URL特性

### 1. 时效性
- 默认有效期: 1小时 (3600秒)
- 可自定义: 最长7天 (v4签名) / 30年 (v2签名)
- 过期后自动失效

### 2. 安全性
- 包含签名验证
- 无需暴露凭证
- 可限制访问方法(GET/PUT/DELETE)

### 3. 灵活性
- 可设置响应头
- 可控制浏览器行为(预览/下载)
- 可重命名下载文件

---

## 最佳实践

### 1. URL有效期设置
```python
# 短期任务: 1小时
PRESIGNED_URL_EXPIRE_SECONDS = 3600

# 长期任务: 24小时
PRESIGNED_URL_EXPIRE_SECONDS = 86400
```

### 2. 错误处理
```java
try {
    downloadByPresignedUrl(url, savePath);
} catch (IOException e) {
    // URL可能已过期,重新请求
    if (e.getMessage().contains("403") || e.getMessage().contains("expired")) {
        // 重新获取URL
    }
}
```

### 3. 并发下载
```java
// 使用线程池并发下载多个文件
ExecutorService executor = Executors.newFixedThreadPool(4);
for (String url : downloadUrls) {
    executor.submit(() -> downloadByPresignedUrl(url, savePath));
}
executor.shutdown();
```

---

## 总结

### 推荐方案: **方案B (预签名URL)**

**理由**:
1. ✅ 音立方无需SDK,降低依赖
2. ✅ 代码更简洁,易于维护
3. ✅ 安全性高,URL有时效性
4. ✅ 灵活性强,易于扩展
5. ✅ 降低维护成本

**适用场景**:
- 音立方不想引入SDK依赖
- 需要快速集成
- 代码简洁性要求高
- 需要临时分享链接

---

## 文件清单

1. **api_service_ecloud.py** - MSST端API服务 (Python)
2. **音立方移动云对接Demo.java** - 音立方端完整Demo (Java)
3. **移动云文件上传下载Demo.java** - 移动云SDK使用示例 (Java)
4. **移动云方案对比.md** - 本文档