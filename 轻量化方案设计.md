# 轻量化方案 - 职责分离设计

## 方案设计理念

### 核心理念
- **MSST**: 轻量化,无SDK依赖,只负责音频分离
- **音立方**: 管理移动云存储,生成预签名URL,调用MSST

### 职责分离

| 服务 | 职责 | 依赖 |
|------|------|------|
| **MSST** | 音频分离 | 无SDK,仅需HTTP客户端 |
| **音立方** | 存储管理 + 业务逻辑 | 移动云SDK |

---

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                      音立方服务 (管理端)                      │
│  - 管理移动云存储                                            │
│  - 生成预签名URL                                            │
│  - 业务逻辑处理                                              │
│  - 移动云SDK依赖                                            │
└────────────┬────────────────────────────────────────────────┘
             │
             │ 1. 上传音频到移动云
             │ 2. 生成下载预签名URL
             │ 3. 预生成上传预签名URL
             │ 4. 调用MSST API (传递预签名URL)
             │ 5. 接收回调
             ▼
┌─────────────────────────────────────────────────────────────┐
│                    MSST服务 (处理端)                         │
│  - 通过预签名URL下载文件 (HTTP)                              │
│  - 执行音频分离                                              │
│  - 上传到预签名URL (HTTP)                                    │
│  - 回调通知音立方                                            │
│  - 无SDK依赖,轻量化                                          │
└────────────┬────────────────────────────────────────────────┘
             │
             │ 6. 回调通知
             ▼
┌─────────────────────────────────────────────────────────────┐
│                      音立方服务                              │
│  - 处理结果                                                  │
│  - 业务逻辑                                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 接口设计

### MSST API (轻量化)

#### 请求接口
```
POST /process_lightweight
Content-Type: application/json

{
  "task_id": "uuid-123",
  "preset_name": "my_preset",
  "download_url": "https://eos-wuxi-1.cmecloud.cn/...?AWSAccessKeyId=...&Expires=...&Signature=...",
  "upload_urls": {
    "input_vocals.wav": "https://eos-wuxi-1.cmecloud.cn/...?AWSAccessKeyId=...&Expires=...&Signature=...",
    "input_instrumental.wav": "https://eos-wuxi-1.cmecloud.cn/...?AWSAccessKeyId=...&Expires=...&Signature=..."
  },
  "callback_url": "http://your-server/callback"
}
```

#### 响应接口
```json
{
  "task_id": "uuid-123",
  "status": "accepted",
  "message": "Task accepted, processing in background"
}
```

#### 回调接口
```json
{
  "task_id": "uuid-123",
  "status": "completed",
  "uploaded_files": ["input_vocals.wav", "input_instrumental.wav"],
  "message": "Success"
}
```

---

## 完整流程

### 步骤1: 音立方上传音频到移动云

```java
// 音立方服务
String inputObjectName = "input/" + audioFile.getName();
String etag = uploadAudioToEcloud(audioFile, inputObjectName);
```

### 步骤2: 音立方生成预签名URL

```java
// 生成下载URL (用于MSST下载输入文件)
String downloadUrl = generateDownloadPresignedUrl(inputObjectName, 3600);

// 预生成上传URL (用于MSST上传结果文件)
List<String> resultObjectNames = Arrays.asList(
    "separated/" + UUID.randomUUID() + "/input_vocals.wav",
    "separated/" + UUID.randomUUID() + "/input_instrumental.wav"
);

Map<String, String> uploadUrls = new HashMap<>();
for (String objectName : resultObjectNames) {
    String fileName = objectName.substring(objectName.lastIndexOf("/") + 1);
    String url = generateUploadPresignedUrl(Arrays.asList(objectName), 3600).get(objectName);
    uploadUrls.put(fileName, url);
}
```

### 步骤3: 音立方调用MSST API

```java
// 调用MSST轻量化API
String taskId = processAudioWithPresignedUrls(
    downloadUrl,      // 下载预签名URL
    uploadUrls,        // 上传预签名URL映射
    "my_preset",      // Preset配置
    "http://your-server/callback"  // 回调地址
);
```

### 步骤4: MSST下载文件

```python
# MSST服务 (无需SDK)
async def download_from_url(url: str, local_path: str):
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            content = await response.read()
            with open(local_path, 'wb') as f:
                f.write(content)
```

### 步骤5: MSST执行音频分离

```python
# MSST服务
engine = PresetInfer(preset_data, force_cpu=False, logger=logger)
engine.process_folder(task_input_dir, task_output_dir, "wav", extra_output=True)
```

### 步骤6: MSST上传结果

```python
# MSST服务 (无需SDK)
async def upload_to_url(local_path: str, upload_url: str):
    async with aiohttp.ClientSession() as session:
        with open(local_path, 'rb') as f:
            async with session.put(upload_url, data=f) as response:
                if response.status == 200:
                    return True
```

### 步骤7: MSST回调通知

```python
# MSST服务
payload = {
    "task_id": task_id,
    "status": status,
    "uploaded_files": uploaded_files,
    "message": message
}
await session.post(callback_url, json=payload)
```

### 步骤8: 音立方处理回调

```java
// 音立方服务
public String handleCallback(String callbackData) {
    CallbackData data = gson.fromJson(callbackData, CallbackData.class);
    
    if ("completed".equals(data.getStatus())) {
        // 结果文件已通过预签名URL上传到移动云
        // 可以从移动云下载或直接使用移动云URL
        System.out.println("上传的文件: " + data.getUploaded_files());
    }
    
    return "OK";
}
```

---

## 优势对比

### 轻量化方案 (新方案) vs 原方案

| 对比项 | 轻量化方案 | 原方案 |
|--------|-----------|--------|
| **MSST依赖** | 无SDK,仅需HTTP | 需要移动云SDK |
| **MSST代码量** | 少 | 多 |
| **MSST维护成本** | 低 | 高 |
| **职责分离** | 清晰 | 模糊 |
| **业务逻辑** | 音立方管理 | MSST管理 |
| **扩展性** | 高 | 中 |
| **存储管理** | 音立方负责 | MSST负责 |

---

## 文件清单

### MSST端
1. **api_service_lightweight.py** - 轻量化API服务
   - 无SDK依赖
   - 通过预签名URL下载/上传
   - 只负责音频分离

### 音立方端
1. **音立方服务完整Demo.java** - 完整业务逻辑
   - 管理移动云存储
   - 生成预签名URL
   - 调用MSST API
   - 处理回调

---

## 配置说明

### MSST端配置
```python
# 无需配置移动云凭证
# 只需启动服务
python api_service_lightweight.py
```

### 音立方端配置
```java
// 配置移动云凭证
private static final String EOS_ENDPOINT = "https://eos-wuxi-1.cmecloud.cn";
private static final String EOS_ACCESS_KEY = "<your-access-key>";
private static final String EOS_SECRET_KEY = "<your-secret-access-key>";
private static final String EOS_BUCKET = "<your-bucket-name>";

// 配置MSST API地址
private static final String MSST_API_BASE_URL = "http://117.50.182.134:8000";
```

---

## 总结

### 核心优势

1. **MSST轻量化**
   - 无需移动云SDK
   - 只需HTTP客户端
   - 代码简洁

2. **职责清晰**
   - 音立方: 存储管理 + 业务逻辑
   - MSST: 音频分离

3. **易于维护**
   - MSST无需关注存储
   - 音立方管理所有存储相关逻辑

4. **扩展性强**
   - 可以轻松切换存储服务
   - MSST无需修改

### 适用场景

- MSST不是主营业务服务器
- 音立方负责业务逻辑和存储管理
- 需要MSST轻量化
- 职责分离要求高